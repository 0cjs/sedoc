<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>SD-6031 の仕様</title>
<link rel="stylesheet" href="../design.css" type="text/css">
</head>
<body>

<h1>
SD-6031 の仕様
</h1>

<h2>
ドライブ、トラック、セクタの表し方
</h2>

<p>
ドライブ番号:  0 〜 3 (BASIC で言うドライブ 1 が 0)<br>
論理トラック番号: 0 〜34 (1D), 79 (2D)<br>
セクタ: 1 〜 16
</p>

<p>
1D モードの場合、論理トラック番号は２倍される。
</p>

<h2>
P31  フォーマット
</h2>

<p>
P31 フォーマットは、2D ディスクのデータ部分のみを記録したフォーマットであり、
2D ディスクの 1 セクタが、FAT16 の 1 セクタに対応する。
2D ディスクの 1 セクタは 256 バイトで、FAT16 の 1 セクタは 512 バイトなので、
FAT16 のセクタの後半 256 バイトは使用しない。<br>
さらに、PC-6001 においては 2D の片面しか使用しないため、
ファイルのサイズは実際のデータのサイズの 4 倍になる。
</p>

<p>
PC-6001 のエミュレータにおいては、2D の D88 フォーマットの片面を使用して
1D のディスクを表現する。エミュレータは、ディスクへのアクセス時にトラック番号を２倍にする。
本機でも、スイッチを 1D にするか、コマンド 23 で 1D を選ぶと、
トラック番号を２倍にしてアクセスする。
</p>

<h2>
実装されているコマンドの詳細
</h2>

<h3>
コマンド 0
</h3>

<p>
ドライブの初期化（本機では何もしない）<br>
レトロ PC -> 本機: 0
<p>

<h3>
コマンド 1
</h3>
<p>
セクタ数の長さ (1-16) のデータを、指定したドライブ番号、トラック番号、セクタ番号から書き込む。<br>
二つのトラックにまたがる書き込みは出来ない。<br>
セクタ 16 の次はセクタ 1 に戻る。<br>
レトロ PC -> 本機: 1, セクタ数, ドライブ番号, 論理トラック番号, セクタ番号, データ...
</p>

<h3>
コマンド 2
</h3>
<p>
セクタ数の長さ (1-16) のデータを、指定したドライブ番号、トラック番号、セクタ番号からリード・バッファに読み出す。<br>
本機では、SD カードからの実際の読み出しはコマンド 3 又は 18 で行う。<br>
二つのトラックにまたがる読み込みは出来ない。<br>
セクタ 16 の次はセクタ 1 に戻る。<br>
レトロ PC -> 本機: 2, セクタ数, ドライブ番号, 論理トラック番号, セクタ番号
<p>

<h3>
コマンド 3
</h3>
<p>
コマンド 2 で指定したデータをレトロ PC に読み出す。転送されるデータ量はコマンド 2 で指定したデータ量。<br>
レトロ PC -> 本機: 3<br>
本機 -> レトロ PC: データ...
</p>

<h3>
コマンド 4
</h3>

<p>
指定したドライブ番号、トラック番号、セクタ番号から、指定したドライブ番号、トラック番号、セクタ番号へ、
セクタ数の長さ分コピーする。<br>
二つのトラックにまたがるコピーは出来ない。<br>
レトロ PC -> 本機: 4, セクタ数, ソースドライブ番号, ソース論理トラック番号, ソースセクタ番号,<br> 
ディスティネーションドライブ番号,  ディスティネーション論理トラック番号, ディスティネーションセクタ番号
</p>

<h3>
コマンド 5
</h3>

<p>
指定したドライブ番号のディスクをフォーマットする。<br>
レトロ PC -> 本機: 5, ドライブ番号
</p>

<h3>
コマンド 6
</h3>

<p>
直前のコマンドの実行結果を得る。<br>
第 7  ビット: 常に 1<br>
第 6 ビット: リード・ バッファにデータがあるなら 1<br>
第 0 ビット: 直前のコマンドがエラーなら 1<br>
レトロ PC -> 本機: 6<br>
本機 -> レトロ PC: 実行結果
</p>

<h3>
コマンド 7
</h3>

<p>
ドライブの状態を得る。<br>
第 4 ビット: ドライブ 1 がマウントされていれば 1<br>
第 5 ビット: ドライブ 2 がマウントされていれば 1<br>
レトロ PC -> 本機: 7<br>
本機 -> レトロ PC: ドライブの状態<br>
</p>

<h3>
コマンド 8 - 10
</h3>

<p>
未実装
</p>

<h3>
コマンド 11
</h3>

<p>
ディスクユニット内のメモリの内容を本体に転送するコマンドだが、本機では未実装。<br>
（75Fh 番地、または 7EFh 番地の内容を聞かれた場合のみ、それぞれ 77h, EFh を返す。）<br>
レトロ PC -> 本機: 11, スタートアドレス上位, 下位, データ量の上位, 下位<br>
本機 -> レトロ PC: データ
</p>

<h3>
コマンド 12 - 16
</h3>

<p>
未実装
</p>

<h3>
コマンド 17
</h3>

<p>
コマンド 1 と同じだが、ハイスピード・ハンドシェークで転送する。未検証。
</p>

<h3>
コマンド 18
</h3>

<p>
コマンド 3 と同じだが、ハイスピード・ハンドシェークで転送する。未検証。
</p>

<h3>
コマンド 23
</h3>

<p>
データの下位4ビットで、各ドライブを 2D にするか 1D にするかを指定。2D ならビットが1、1D ならビットが 0。<br>
レトロ PC -> 本機: 23, データ
</p>

<h3>
コマンド 24
</h3>

<p>
コマンド 23 で指定した、1D / 2D の指定を返す。<br>
レトロ PC -> 本機: 24<br>
本機 -> レトロ PC: データ
</p>
</p>

<h2>
レトロ PC と本機のハンドシェークの方法
</h2>

<h3>
レトロ PC へデータを送る
</h3> 

<p>
RFD が 1 になるのを待つ<br>
データを出力<br>
DAV に 1 を出力<br>
DAC が 1 になるのを待つ<br>
( ハイスピード・ハンドシェークの場合、２バイト目を出力 )<br>
DAV に 0 を出力<br>
DAC が 0 になるのを待つ
</p>

<h3>
レトロ PC からデータを受ける
</h3>

<p>
RFD に 1 を出力<br>
DAV が 1 になるのを待つ<br>
RFD に 0 を出力<br>
データを入力<br>
DAC に 1 を出力<br>
DAV が 0 になるまで待つ<br>
( ハイスピード・ハンドシェークの場合、2 バイト目を入力 )<br>
DAC を 0 にする
</p>

<h3>
ATN の扱い
</h3>

<p>
本機は、まず ATN が 1 になるのを待ち、コマンドを受け取り、ATN が 0 になれば、
以下のパラメータを受け取り、コマンドを実行する。
</p>

<h2>
資料
</h2>

<h3>
PC-6001 mkII のフロッピーディスク端子
</h3>

<table border=1>
<tr><td>端子番号</td><td>端子名</td><td>入出力</td><td>機能</td></tr>
<tr><td>1〜8</td><td>PB0-7</td><td>出力</td><td>データ出力</td></tr>
<tr><td>9</td><td>N.C.</td><td>-</td><td></td></tr>
<tr><td>10〜18</td><td>GND</td><td>-</td><td>信号グランド</td></tr>
<tr><td>19〜26</td><td>PA0-7</td><td>入力</td><td>データ入力</td></tr>
<tr><td>27〜30</td><td>PC4-7</td><td>出力</td><td>ATN: DAC: RFD: DAV</td></tr>
<tr><td>31〜34</td><td>PC0-3</td><td>入力</td><td>ATN: DAC: RFD: DAV</td></tr>
<tr><td>35</td><td>RESET</td><td>出力</td><td>リセット</td></tr>
<tr><td>36</td><td>GND</td><td>-</td><td>信号グランド</td></tr>
</table>

<h3>
参考文献
</h3>

<p>
PC-8801、mkII DISK 活用ハンドブック、 藤井保則、星野博和、テクノポリス・ブックス<br>
フロッピディスク入門ハンドブック、山内　直著、秀和システムトレーディング
</p>

</body>
</html>
