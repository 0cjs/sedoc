Nix Package Manager
===================

[NixOS] is a Linux distribution that uses the [Nix] package manager and the
[Nixpkgs] channel. However, Nix itself requires neither of these and can be
used standalone on any Linux distro or MacOS.


Installation
------------

* __Debian:__ `apt-get install nix-bin` and add yourself to the `nix-users`
  group. (The `nix-setup-systemd` package for the Nix daemon will be
  included as a recommendation unless you specifically exclude it.)
* __Arch:__ `nix` and `archlinux-nix` packages available, but seems to
  require [some manual configuration][arch].
* __Vendor:__ [Binary install][nix instbin] typically via `sh <(curl -L
  https://nixos.org/nix/install) --daemon`, or [build from source][nix
  instsrc]


Overview
--------

Paths:

    /nix/store/             object store
    /nix/var/nix/profiles/  profile symlinks into /nix/store/*-environment
    ~/.nix-profile          symlink to current environment
    ~/.nix-channels         file listing channels
    ~/.nix-defexpr/         (see nix-env(1) manpage)

Most Nix package-related information outside `/nix/store/` is just symlinks
into that object store. In a "multi-user" configuration all changes to
`/nix/` are handled by the Nix daemon, which also has its own user IDs for
building things. Nix can also be used in a "single-user" configuration
where `/nix/` is owned by a user.

Nix packages are are instances of a more general object, the _derivation_,
which is anything generated by a build action (including downloaded source,
intermediate build products, profiles, channel information, etc.). These
are generated by evaluating _expressions_ in the pure, lazy, functional
[Nix expression language][nix expr]. Derivations are stored under
`/nix/store/` in files named for an SHA256 of the inputs followed by a
(human-readable) symbolic name that is used by `nix-env`.

### Environments and Profiles

An _environment_ is a directory in the store that provides a standard Unix
$PREFIX hierarchy (`bin/`, `share/`, etc.) giving a synthesized view of a
subset of packages in the whole store. This view includes filename
priority, usually determined by the order in which packages were installed,
so an environment with A then B installed is different from an environment
with B then A installed. Environments will be re-used if a sequence of
install commands produces the same environment as one that already exists.

A _profile_ is a name for a set of environments called _generations_ of
that profile, one of which is the _current generation_. The generations
have no relationship to each other; if the higest generation number is _M_:
any command that creates a new environment always assigns generation _M+1_
regardless of the current generation and `nix-env --rollback` always
switches to the highest generation less than _M_, regardless of what the
previous generation actually was. Thus, if the highest generation number is
6, switching from 5 to 3 and installing a package will take you to
generation 7, and rollback will take you to 6, not 3.

Profiles are implemented as a naming and symlinking convention. Profile
`PNAME` is a symlink to a generation `PNAME-1-link`, which in turn is a
symlink to an environment `/nix/store/...-user-environment/` which contains
the hierarchy. The _active profile_ is the one currently being operated on
(the current profile below or specified with `-p PNAME`).

`~/.nix-profile` is a symlink indicating the _current profile_, which is
used when `-p PNAME` is not specified. The user typically will add
`~/.nix-profile/bin/` to his $PATH.

With no current profile, profile modification commands will create a new
profile `/nix/var/nix/profiles/per-user/USER/profile` and set the current
profile to that. That directory is owned by the user but is not special
otherwise; creating and using other profiles in that directory requires
specifying the full path. (User channel information is also stored there.)

### Useful Commands

`--dry-run` and `-v` (verbose) options available on pretty much everything.

    sudo nix-daemon --daemon &  # start daemon in docker container
    nix ping-store      # (no args) check if daemon is running and accessible
    nix-env -qa         # Query packages; -a = all (uninstalled too; slow)

    #   Nixpkgs "standard library"
    nix-channel --add https://nixos.org/channels/nixpkgs-unstable
    nix-channel --update
    nix-channel --list
    nix-env -qas        # status of packages

    nix-store --gc --print-roots
    nix-store --gc --print-live

### nix-env

Takes one operation: `-q` query, `-i` install, `-u` upgrade, etc. Bare
arguments are "selectors" that are regexps; bare names appear to match
everything up to but not including the last hyphen and what trails it,
which seems to be considered the "version" of the package.

Operations on a profile (default or given with `-p`)
* `-q` query (selector optional)
  * : `-s` for status (`IPS`=installed in current user env, present on
    system, "substitute" available i.e. pre-built binary can be fetched)
* `-i` install (selector required): creates new user environment with this
  package added (even if same version already present).
* `-u` (selector optional): Replace current versions of listed packages
  (all in env if no selector) with newer versions, if available.
* `-e` / `--uninstall` (selector required): remove a package

Profile management commands:
* `-S PATH`/`--switch-profile PATH`: Change the `~/.nix-profile` symlink to
  point to `PATH`. Non-absolute paths are relative to CWD. No validity
  checks are done.
* `--list-generations`
* `-G N`, `--switch-generation N`: Change current generation to _N_.
* `--rollback`: Switch to the highest-numbered generation less than the
  current one.
* `--delete-generations N ...`: Delete given generations. "`old`" will
  delete all non-current generations, `30d` all older than 30 days, and
  `+N` to keep the last _N_. Users must use this reguarly for GC to be
  effective.


Channels
--------


Misc
----

- Nixpkgs offers a `dockerTools` package to help automate [building Docker
  images][docker].



<!-------------------------------------------------------------------->
[NixOS]: https://nixos.org/manual/nixos/stable/
[Nix]: https://nixos.org/manual/nix/stable/
[Nixpkgs]: https://nixos.org/manual/nixpkgs/stable/

[arch]: https://wiki.archlinux.org/title/Nix
[nix expr]: https://nixos.org/manual/nix/stable/#ch-expression-language
[nix instsrc]: https://nixos.org/manual/nix/stable/#ch-installing-source
[nix instbin]: https://nixos.org/manual/nix/stable/#ch-installing-binary

[docker]: https://nix.dev/tutorials/building-and-running-docker-images
